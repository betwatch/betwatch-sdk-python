name: Create Release

permissions:
  contents: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      
      - name: Install dependencies
        run: |
          uv sync
      
      - name: Install git-cliff
        run: |
          wget https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf git-cliff-2.7.0-x86_64-unknown-linux-gnu.tar.gz
          sudo mv git-cliff-2.7.0/git-cliff /usr/local/bin/
          chmod +x /usr/local/bin/git-cliff
      
      - name: Bump version using commitizen
        id: bump
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Bump version and capture new version
          uv run cz bump --yes --increment ${{ inputs.bump }}
          NEW_VERSION=$(uv run cz version --project)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"
      
      - name: Generate changelog for release notes
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          CURRENT_TAG="v${{ steps.bump.outputs.version }}"
          
          if [ -z "$PREV_TAG" ]; then
            echo "First release - generating full changelog"
            git-cliff --unreleased --strip all > release_notes.md
          else
            echo "Generating changelog from $PREV_TAG to $CURRENT_TAG"
            git-cliff $PREV_TAG..$CURRENT_TAG --strip all > release_notes.md
          fi
          
          cat release_notes.md
      
      - name: Push changes to main
        run: |
          git push origin main --follow-tags
      
      - name: Create GitHub release
        run: |
          gh release create "v${{ steps.bump.outputs.version }}" \
            --title "v${{ steps.bump.outputs.version }}" \
            --notes-file release_notes.md \
            --target main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build package
        run: |
          uv build
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: true
